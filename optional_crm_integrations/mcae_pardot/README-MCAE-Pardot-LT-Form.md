# Pardot Integration 
## Layout Template Form Tab
### (with console messages)

### Change these two things: https://your-wp-domain.com and PASTE_YOUR_API_KEY_HERE
```
<style type="text/css">
    /* --- Modern Form Styles --- */
    #pardot-form {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        color: #333;
        padding: 20px; /* Add some padding around the form */
        background-color: #f9f9f9; /* Optional: light background for the form area */
        border-radius: 8px; /* Optional: rounded corners */
        max-width: 600px; /* Optional: constrain form width */
        margin: 20px auto; /* Optional: center form on page */
    }

    /* General error message at the top */
    #pardot-form p.errors { /* Pardot's default error wrapper */
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 0.9em;
    }

    /* Form field wrapper */
    #pardot-form p.form-field {
        margin-bottom: 20px; /* Space between fields */
        padding: 0; /* Reset Pardot default padding if any */
    }

    /* Field Label - Positioned on top */
    #pardot-form label.field-label {
        display: block; /* Makes the label take its own line */
        font-weight: 600;
        margin-bottom: 8px; /* Space between label and input */
        font-size: 0.95em;
        color: #333;
    }

    /* Input fields, textareas, selects */
    #pardot-form input[type="text"],
    #pardot-form input[type="email"],
    #pardot-form input[type="tel"],
    #pardot-form input[type="url"],
    #pardot-form input[type="password"],
    #pardot-form input[type="number"],
    #pardot-form input[type="date"],
    #pardot-form textarea,
    #pardot-form select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* Important for 100% width + padding */
        font-size: 1em;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    #pardot-form textarea {
        min-height: 100px;
        resize: vertical;
    }
    #pardot-form input:focus,
    #pardot-form textarea:focus,
    #pardot-form select:focus {
        border-color: #007bff; /* Highlight color on focus */
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        outline: none;
    }

    /* Field descriptions */
    #pardot-form span.description {
        display: block;
        font-size: 0.85em;
        color: #666;
        margin-top: 6px;
    }

    /* Field-specific error messages (Pardot's default) */
    #pardot-form p.error.no-label { /* This is how Pardot typically renders field-specific errors */
        color: #c0392b; /* Red for errors */
        font-size: 0.85em;
        margin-top: 6px;
        margin-bottom: 0;
    }
    /* Highlight fields with Pardot errors */
    #pardot-form p.form-field.error input,
    #pardot-form p.form-field.error textarea,
    #pardot-form p.form-field.error select {
        border-color: #c0392b;
    }

    /* Error messages generated by THIS custom script */
    #pardot-form .pardot-block-error-message { /* Class added by your script */
        color: #c0392b;
        font-size: 0.85em;
        margin-top: 6px;
        display: block; /* Ensure it's visible */
    }
    /* Style for the specific error div used by the script */
    #pardot-form div[id^="custom_error_for_"] { /* Changed ID prefix to avoid conflict */
        margin-top: 5px;
    }


    /* Checkbox and Radio button styling */
    #pardot-form .checkbox label,
    #pardot-form .radio label {
        font-weight: normal;
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
    }
    #pardot-form .checkbox input[type="checkbox"],
    #pardot-form .radio input[type="radio"] {
        width: auto;
        margin-right: 8px;
        margin-top:0;
    }
    #pardot-form p.form-field p { /* If Pardot wraps options in <p> */
        margin-bottom: 5px;
    }


    /* Submit button */
    #pardot-form p.submit {
        margin-top: 25px;
        text-align: left;
    }
    #pardot-form p.submit input[type="submit"] {
        background-color: #007bff;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 4px;
        font-size: 1.05em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    #pardot-form p.submit input[type="submit"]:hover {
        background-color: #0056b3;
    }
    #pardot-form p.submit input[type="submit"]:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #pardot-form .hidden { display: none !important; }

    #pardot-form .form-success,
    #pardot-form .form_thank_you_message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 15px;
        border-radius: 4px;
        text-align: center;
    }
</style>

<form accept-charset="UTF-8" method="post" action="%%form-action-url%%" class="form" id="pardot-form">
    %%form-opening-general-content%%

    %%form-if-thank-you%%
        %%form-javascript-focus%%
        <div class="form_thank_you_message">
            %%form-thank-you-content%%
        </div>
        %%form-thank-you-code%%
    %%form-end-if-thank-you%%

    %%form-if-display-form%%
        %%form-before-form-content%%
            %%form-if-error%%
                <p class="errors">Please correct the errors below:</p>
            %%form-end-if-error%%

            %%form-start-loop-fields%%
                <p class="form-field %%form-field-css-classes%% %%form-field-class-type%% %%form-field-class-required%% %%form-field-class-hidden%% %%form-field-class-no-label%% %%form-field-class-error%% %%form-field-dependency-css%%">
                    %%form-if-field-label%%
                        <label class="field-label" for="%%form-field-id%%">%%form-field-label%%</label>
                    %%form-end-if-field-label%%

                    %%form-field-input%%
                    %%form-if-field-description%%
                        <span class="description">%%form-field-description%%</span>
                    %%form-end-if-field-description%%

                    %%form-field-if-error%%
                        <p class="error no-label">%%form-field-error-message%%</p>
                    %%form-field-end-if-error%%
                </p>
                <!-- Div for custom script's error messages for this field -->
                <div id="custom_error_for_%%form-field-id%%" style="display:none;"></div>
            %%form-end-loop-fields%%

            %%form-spam-trap-field%%
            <input name="_utf8" type="hidden" value="â˜ƒ" />

            <p class="submit">
                <input type="submit" accesskey="s" value="%%form-submit-button-text%%" %%form-submit-disabled%%/>
            </p>
        %%form-after-form-content%%
    %%form-end-if-display-form%%

    %%form-javascript-link-target-top%%

    <!-- ADVANCED FORMS BLOCKER SCRIPT -->
    <script type="text/javascript">
    // Ensure this script runs after jQuery is loaded (Pardot layout templates typically include jQuery)
    if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function($) {
            console.log('Advanced Forms Blocker: Pardot Script Initializing.');

            // --- CONFIGURATION: User needs to update these ---
            const YOUR_WORDPRESS_SITE_BASE_URL = 'https://your-wp-domain.com'; // E.g., 'https://example.com'
            const YOUR_API_KEY = 'PASTE_YOUR_API_KEY_HERE'; // Get this from WordPress Settings > Form Blocker
            // --- END CONFIGURATION ---

            const wordpressApiUrlBase = YOUR_WORDPRESS_SITE_BASE_URL.replace(/\/+$/, "") + '/wp-json/afb/v1/list';
            let blockedDomains = [];
            let blockedEmails = [];
            let customMessages = {
                blocked_email: 'This email address is not allowed for submission.', // Default
                blocked_domain: 'Submissions from this email domain are not allowed.' // Default
            };
            let blocklistLoaded = false;
            const form = $('#pardot-form'); // Ensure your Pardot form has id="pardot-form"

            // Function to fetch the blocklist from the WordPress API
            function fetchBlocklist() {
                console.log('Advanced Forms Blocker: Fetching blocklist...');
                if (!YOUR_API_KEY || YOUR_API_KEY === 'PASTE_YOUR_API_KEY_HERE') {
                    console.error('Advanced Forms Blocker: API Key not configured in Pardot script. Validation disabled.');
                    blocklistLoaded = false;
                    return;
                }
                if (!YOUR_WORDPRESS_SITE_BASE_URL || YOUR_WORDPRESS_SITE_BASE_URL === 'https://your-wp-domain.com') {
                    console.error('Advanced Forms Blocker: WordPress Site Base URL not configured. Validation disabled.');
                    blocklistLoaded = false;
                    return;
                }

                const fullApiUrl = wordpressApiUrlBase + '?key=' + YOUR_API_KEY;

                $.ajax({
                    url: fullApiUrl,
                    method: 'GET',
                    dataType: 'json',
                    timeout: 8000,
                    success: function(data) {
                        console.log('Advanced Forms Blocker: API success. Data received:', data);
                        if (data && Array.isArray(data.domains) && Array.isArray(data.emails) && data.messages && typeof data.messages === 'object') {
                            blockedDomains = data.domains.map(domain => domain.toLowerCase());
                            blockedEmails = data.emails.map(email => email.toLowerCase()); // Also lowercase blocked emails for consistent checking
                            
                            // Use messages from API if available, otherwise keep defaults
                            customMessages.blocked_email = data.messages.blocked_email || customMessages.blocked_email;
                            customMessages.blocked_domain = data.messages.blocked_domain || customMessages.blocked_domain;

                            blocklistLoaded = true;
                            console.log('Advanced Forms Blocker: Blocklist and messages loaded successfully.');
                            console.log('Domains:', blockedDomains, 'Emails:', blockedEmails, 'Messages:', customMessages);
                        } else {
                            console.error('Advanced Forms Blocker: Invalid data format from API.', data);
                            blocklistLoaded = false;
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Advanced Forms Blocker: Error fetching blocklist. Status: ' + textStatus + ', Error: ' + errorThrown, jqXHR.responseText);
                        blocklistLoaded = false;
                    }
                });
            }

            fetchBlocklist(); // Fetch on page load

            // Function to display validation errors
            function showBlockError(message, fieldElement) {
                const fieldId = fieldElement.attr('id') || fieldElement.attr('name'); // Pardot might not always have ID
                const errorDivId = 'custom_error_for_' + fieldId.replace(/[^a-zA-Z0-9_]/g, '_'); // Sanitize ID for selector
                let errorArea = $('#' + errorDivId);

                if (!errorArea.length) { // If specific error div doesn't exist, create it after the field's parent <p>
                    // This is a fallback, ideally the div is in the HTML structure as per your %%form-loop-fields%%
                    console.warn('Advanced Forms Blocker: Error div ' + errorDivId + ' not found. Appending dynamically.');
                    fieldElement.closest('p.form-field').after('<div id="' + errorDivId + '" class="pardot-block-error-message" style="display:none;"></div>');
                    errorArea = $('#' + errorDivId);
                }
                
                errorArea.text(message).addClass('pardot-block-error-message').show();
                fieldElement.css('border-color', '#c0392b'); // Highlight field
            }

            // Function to clear validation errors
            function clearBlockError(fieldElement) {
                const fieldId = fieldElement.attr('id') || fieldElement.attr('name');
                const errorDivId = 'custom_error_for_' + fieldId.replace(/[^a-zA-Z0-9_]/g, '_');
                $('#' + errorDivId).text('').hide().removeClass('pardot-block-error-message');
                fieldElement.css('border-color', ''); // Remove highlight
            }

            // Form submission handler
            form.on('submit', function(e) {
                console.log('Advanced Forms Blocker: Form submit triggered.');
                if (!blocklistLoaded) {
                    console.warn('Advanced Forms Blocker: Blocklist not loaded. Allowing submission (or relying on server-side if any).');
                    return true; // Allow submission if list isn't ready
                }

                // Find the primary email field. Adjust selector if needed for your specific Pardot form fields.
                // Common Pardot email field names often contain 'email'.
                const emailField = form.find('input[type="email"], input[name*="email"]').first(); 
                if (!emailField.length) {
                    console.warn('Advanced Forms Blocker: Email field not found in form. Skipping client-side validation.');
                    return true;
                }

                const emailValue = emailField.val().trim().toLowerCase(); // Trim and lowercase for comparison
                clearBlockError(emailField); // Clear previous errors for this field

                if (!emailValue) {
                    console.log('Advanced Forms Blocker: Email field is empty.');
                    return true; // Allow submission if email is empty (Pardot handles required)
                }

                let isBlocked = false;
                let blockMessage = '';

                // Check against blocked emails
                if (blockedEmails.includes(emailValue)) {
                    isBlocked = true;
                    blockMessage = customMessages.blocked_email;
                    console.log('Advanced Forms Blocker: Email blocked (direct match).', emailValue);
                }

                // Check against blocked domains if not already blocked by email
                if (!isBlocked) {
                    const emailParts = emailValue.split('@');
                    if (emailParts.length === 2) {
                        const domain = emailParts[1]; // Domain is already lowercased from blockedDomains list
                        if (blockedDomains.includes(domain)) {
                            isBlocked = true;
                            blockMessage = customMessages.blocked_domain;
                            console.log('Advanced Forms Blocker: Domain blocked.', domain);
                        }
                    }
                }

                if (isBlocked) {
                    e.preventDefault(); // Stop form submission
                    showBlockError(blockMessage, emailField);
                    console.log('Advanced Forms Blocker: Submission prevented.');
                    return false;
                }

                console.log('Advanced Forms Blocker: Submission allowed.');
                return true; // Allow submission
            });

            // Optional: Validate on blur for earlier feedback
            form.on('blur', 'input[type="email"], input[name*="email"]', function() {
                if (!blocklistLoaded) return;

                const emailField = $(this);
                const emailValue = emailField.val().trim().toLowerCase();
                clearBlockError(emailField);

                if (!emailValue) return;

                let isBlocked = false;
                let blockMessage = '';

                if (blockedEmails.includes(emailValue)) {
                    isBlocked = true;
                    blockMessage = customMessages.blocked_email;
                }
                if (!isBlocked) {
                    const emailParts = emailValue.split('@');
                    if (emailParts.length === 2) {
                        const domain = emailParts[1];
                        if (blockedDomains.includes(domain)) {
                            isBlocked = true;
                            blockMessage = customMessages.blocked_domain;
                        }
                    }
                }
                if (isBlocked) {
                    showBlockError(blockMessage, emailField);
                }
            });
        }); // End jQuery(document).ready()
    } else {
        console.error('Advanced Forms Blocker: jQuery not loaded. Pardot script will not run.');
    }
    </script>
</form>
```